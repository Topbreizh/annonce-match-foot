<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Annonce Matchs - Mobile</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f4f4f4;
      color: #333;
    }
    h1, h2, h3 {
      text-align: center;
      color: #111;
    }
    input[type="file"], select, button, input[type="range"] {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.6rem;
      font-size: 1rem;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.6rem;
      font-size: 0.95rem;
      text-align: center;
    }
    #section-lecture {
      background: #fff;
      padding: 1rem;
      margin-top: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #999;
      cursor: default;
    }
    @media (min-width: 768px) {
      input[type="range"] {
        width: 60%;
      }
    }
  </style>
</head>
<body>

  <h1>üì¢ Annonces de Matchs</h1>
  <input type="file" accept=".xlsx,.csv" onchange="importerExcel(event)" />

  <h3>Voix et configuration</h3>
  <select id="voiceSelect"></select>
  <button onclick="testerVoix()">Tester la voix</button>

  <label>üîä Volume : <span id="volumeLabel">1</span></label>
  <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" />

  <label>‚ö° Vitesse : <span id="rateLabel">1</span></label>
  <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1" />

  <label>üéº Hauteur : <span id="pitchLabel">1</span></label>
  <input type="range" id="pitchSlider" min="0" max="2" step="0.1" value="1" />

  <button onclick="arreterLecture()">‚õî Arr√™ter</button>

  <table id="table-matchs" style="display:none;">
    <thead>
      <tr>
        <th>S√©lect</th><th>Domicile</th><th>Ext√©rieur</th>
        <th>Date</th><th>Heure</th><th>Lieu</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="btn-suivant" style="display:none;" onclick="passerEtape()">‚û°Ô∏è √âtape suivante</button>

  <div id="section-lecture" style="display:none;">
    <h2>üîä Lecture des annonces</h2>
    <p id="etat-lecture">S√©lectionne des matchs.</p>
    <button id="btn-parler" onclick="lireMatchsSelectionnes()">‚ñ∂Ô∏è Parler</button>
    <button onclick="arreterLecture()">‚õî Arr√™ter</button>
  </div>

  <script>
    let matchs = [], voixDisponibles = [], voixChoisie = null;

    // D√©tecter iOS
    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // Afficher alerte iOS
    if (isiOS) {
      alert("‚ö†Ô∏è Sur iPhone/iPad, la s√©lection de voix est limit√©e. La voix par d√©faut sera utilis√©e.");
    }

    function chargerVoix() {
      voixDisponibles = speechSynthesis.getVoices().filter(v => v.lang.startsWith("fr"));
      const select = document.getElementById("voiceSelect");
      select.innerHTML = "";
      voixDisponibles.forEach((v, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${v.name} (${v.lang})`;
        select.appendChild(opt);
      });
      const saved = localStorage.getItem("voiceIndex");
      if (saved && voixDisponibles[saved]) {
        select.value = saved;
        voixChoisie = voixDisponibles[saved];
      } else {
        voixChoisie = voixDisponibles[0] || null;
      }
    }

    // Sur iOS, forcer le chargement voix au premier clic
    function activerVoixIOS() {
      if (isiOS) {
        speechSynthesis.cancel(); // reset
        speechSynthesis.getVoices();
        setTimeout(() => {
          chargerVoix();
        }, 500);
        window.removeEventListener("click", activerVoixIOS);
      }
    }
    window.addEventListener("click", activerVoixIOS);

    // Charger voix au d√©marrage (pour non iOS)
    if (!isiOS) {
      window.speechSynthesis.onvoiceschanged = () => {
        setTimeout(chargerVoix, 500);
      };
      // tenter aussi un appel direct
      setTimeout(chargerVoix, 500);
    }

    document.getElementById("voiceSelect").addEventListener("change", function () {
      voixChoisie = voixDisponibles[this.value];
      localStorage.setItem("voiceIndex", this.value);
    });

    ["volume", "rate", "pitch"].forEach((param) => {
      document
        .getElementById(param + "Slider")
        .addEventListener("input", (e) => {
          document.getElementById(param + "Label").innerText = e.target.value;
        });
    });

    function lireTexte(texte, callback) {
      const u = new SpeechSynthesisUtterance(texte);
      u.lang = "fr-FR";
      if (voixChoisie) u.voice = voixChoisie;
      u.volume = parseFloat(document.getElementById("volumeSlider").value);
      u.rate = parseFloat(document.getElementById("rateSlider").value);
      u.pitch = parseFloat(document.getElementById("pitchSlider").value);
      u.onend = callback;
      speechSynthesis.speak(u);
    }

    function testerVoix() {
      lireTexte("Ceci est un test avec la voix actuelle.", () => {});
    }

    function arreterLecture() {
      speechSynthesis.cancel();
      btnParler.disabled = false;
      btnParler.textContent = "‚ñ∂Ô∏è Parler";
      document.getElementById("etat-lecture").innerText = "‚èπÔ∏è Lecture arr√™t√©e.";
    }

    function importerExcel(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        matchs = json.map((m, i) => ({
          id: i,
          equipe_dom: m.equipe_dom,
          equipe_ext: m.equipe_ext,
          date: m.date,
          heure: m.heure,
          lieu: m.lieu,
          texte_annonce: m.texte_annonce || "",
          selected: false,
        }));

        afficherMatchs();
        document.getElementById("btn-suivant").style.display = "block";
      };
      reader.readAsArrayBuffer(file);
    }

    function afficherMatchs() {
      const tbody = document.querySelector("#table-matchs tbody");
      tbody.innerHTML = "";
      document.getElementById("table-matchs").style.display = "table";

      matchs.forEach((match, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" onchange="toggleSelection(${index}, this.checked)"></td>
          <td>${match.equipe_dom}</td>
          <td>${match.equipe_ext}</td>
          <td>${match.date}</td>
          <td>${match.heure}</td>
          <td>${match.lieu}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function toggleSelection(index, checked) {
      matchs[index].selected = checked;
    }

    function passerEtape() {
      document.getElementById("section-lecture").style.display = "block";
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    function genererAnnonce(match) {
      if (match.texte_annonce && match.texte_annonce.trim() !== "") {
        return match.texte_annonce;
      }
      return `Prochain match : ${match.equipe_dom} affrontera ${match.equipe_ext} le ${match.date} √† ${match.heure}, au ${match.lieu}. Venez nombreux !`;
    }

    const btnParler = document.getElementById("btn-parler");

    function lireMatchsSelectionnes() {
      const selection = matchs.filter(m => m.selected);
      if (selection.length === 0) {
        alert("Aucun match s√©lectionn√© !");
        return;
      }
      btnParler.disabled = true;
      btnParler.textContent = "üîä En cours...";
      lireEnBoucle(selection, 0);
    }

    function lireEnBoucle(liste, index) {
      if (index >= liste.length) {
        document.getElementById("etat-lecture").innerText = "‚úÖ Lecture termin√©e.";
        btnParler.disabled = false;
        btnParler.textContent = "‚ñ∂Ô∏è Parler";
        return;
      }
      const texte = genererAnnonce(liste[index]);
      document.getElementById("etat-lecture").innerText = `Lecture ${index + 1} sur ${liste.length}`;
      lireTexte(texte, () => lireEnBoucle(liste, index + 1));
    }
  </script>
</body>
</html>
